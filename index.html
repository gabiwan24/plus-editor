<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Plus is us</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --size: 30px;            
            --thickness: 5.325px;        
            --grid-size: 100px;
            --col-count: 11; 
            
            /* Farben */
            --bg-color-1: #1500FF;
            --bg-color-2: #000000;
            --bg-grad-angle: 225deg;
            
            /* Plus Farben */
            --plus-col-1: #ffffff;
            --plus-col-2: #dddddd;
            --plus-grad-angle: 45deg;
            --plus-bg: #ffffff; 
            
            /* Bild */
            --bg-image-url: none;
            --bg-x: 0px; --bg-y: 0px; --bg-scale: 1; --bg-opacity: 1; --bg-blend: normal; --bg-filter: none;
            
            /* Tools */
            --brush-size: 100px; --brush-x: -9999px; --brush-y: -9999px;
            
            /* Tiefe Global Config */
            --depth-strength: 0px; 
        }

        body { overflow: hidden; user-select: none; }
        main { position: relative; background: var(--bg-color-1); overflow: hidden; }
        main.has-gradient { background: linear-gradient(var(--bg-grad-angle), var(--bg-color-1), var(--bg-color-2)); }

        #bg-layer { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        #bg-image-element { display: none; transform: translate(var(--bg-x), var(--bg-y)) scale(var(--bg-scale)); transform-origin: center center; max-width: none; opacity: var(--bg-opacity); mix-blend-mode: var(--bg-blend); filter: var(--bg-filter); }

        #grid-container {
            position: relative; z-index: 10; display: grid;
            grid-template-columns: repeat(var(--col-count), var(--grid-size));
            grid-auto-rows: var(--grid-size);
            gap: 0px;
            justify-content: center; align-content: center; justify-items: center; align-items: center;
            width: auto; height: auto; pointer-events: none; 
            
            /* Startzustand für Intro: Unsichtbar */
            opacity: 0;
            transition: opacity 0.8s ease-out;
        }

        /* INTRO LAYER */
        #intro-layer {
            position: absolute; inset: 0; z-index: 100;
            display: flex; align-items: center; justify-content: center;
            pointer-events: none;
            background-color: var(--bg-color-1); 
            transition: opacity 0.5s ease, background-color 0.5s ease;
        }
        
        #intro-svg {
            width: 100%; 
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            transform-origin: 50% 50%; 
            will-change: transform;
        }
        
        #intro-plus-poly { fill: #ffffff; }
        #intro-logo-rest { fill: #ffffff; transition: opacity 0.6s ease-out; }

        #ui-layer { position: absolute; inset: 0; z-index: 40; pointer-events: none; }
        #brush-cursor {
            position: absolute; left: 0; top: 0; width: var(--brush-size); height: var(--brush-size);
            border: 1px dashed rgba(255,255,255,0.8); background: rgba(255,255,255,0.1); border-radius: 50%;
            transform: translate(calc(var(--brush-x) - 50%), calc(var(--brush-y) - 50%));
            pointer-events: none; display: none; z-index: 50;
        }
        #grad-line-svg { position: absolute; inset: 0; width: 100%; height: 100%; display: none; }
        #drop-overlay { display: none; position: absolute; inset: 0; background: rgba(255, 255, 255, 0.5); border: 4px dashed #fff; z-index: 60; align-items: center; justify-content: center; font-size: 2rem; color: #fff; font-weight: bold; pointer-events: none; }

        .plus-shape {
            position: relative; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            contain: size layout style;
            
            --paint-scale: 1; 
            --anim-scale: 1;  
            --th-multi: 1;
            
            width: calc(var(--size) * var(--paint-scale));
            height: calc(var(--size) * var(--paint-scale));
            transform: scale(var(--anim-scale));
            
            filter: blur(var(--local-blur, 0px));
            will-change: transform, filter; 
        }
        
        .bar-h, .bar-v { position: absolute; background: var(--plus-bg); }
        .bar-h { width: 100%; height: calc(var(--thickness) * var(--th-multi) * var(--paint-scale)); }
        .bar-v { height: 100%; width: calc(var(--thickness) * var(--th-multi) * var(--paint-scale)); }
        
        .text-alert { color: #dc2626; font-weight: 700; }
        main.is-editing-bg { cursor: move; cursor: grab; } main.is-editing-bg:active { cursor: grabbing; }
        main.is-editing-grad { cursor: crosshair; } main.is-painting { cursor: none; }
        .disabled-control { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
        .tool-btn.active { background-color: #2563EB; color: white; border-color: #2563EB; }

        #sidebar { transition: transform 0.3s ease, width 0.3s ease, min-width 0.3s ease; will-change: width, transform; }
        #sidebar.collapsed { width: 0 !important; min-width: 0 !important; transform: translateX(-100%); overflow: hidden; border: none; }
        @media (min-aspect-ratio: 1/1) { #sidebar { width: 10%; min-width: 240px; } }
        
        #btn-toggle-menu { position: absolute; top: 10px; left: 10px; z-index: 70; background: white; padding: 6px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: left 0.3s ease; }
        #sidebar.collapsed + main #btn-toggle-menu svg { transform: rotate(180deg); }

        #sidebar-content::-webkit-scrollbar { width: 4px; }
        #sidebar-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        #sidebar-content::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body class="flex w-screen h-screen bg-gray-50 font-sans text-gray-800 text-xs">

    <aside id="sidebar" class="w-1/5 min-w-[240px] bg-white border-r border-gray-200 flex flex-col z-20 shadow-2xl relative h-full">
        <!-- Header -->
        <div class="px-4 py-3 border-b border-gray-100 flex justify-between items-center shrink-0">
            <div class="flex items-center gap-3">
                <div><h1 class="text-sm font-bold text-gray-900 leading-tight">The Plus is us</h1><p class="text-[10px] text-gray-400">v32</p></div>
            </div>
            <div class="flex items-center gap-2">
                <!-- Random Button -->
                <button id="btn-random" class="text-gray-400 hover:text-blue-600 transition-colors" title="Zufallsgenerator">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                </button>
                <button id="btn-close-sidebar" class="text-gray-400 hover:text-gray-700"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
            </div>
        </div>

        <div id="sidebar-content" class="flex-1 px-4 py-2 overflow-y-auto space-y-3">
            
            <!-- Basis Raster -->
            <div class="space-y-2">
                <h2 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Basis Raster</h2>
                <div class="grid grid-cols-[60px_1fr_35px] gap-2 items-center">
                    <label id="label-size" class="text-[10px] font-medium text-gray-600">Größe</label>
                    <input type="range" id="input-size" min="10" max="300" value="30" class="h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    <span id="disp-size" class="text-[10px] text-gray-500 font-mono text-right">30px</span>
                </div>
                <div class="grid grid-cols-[60px_1fr_35px] gap-2 items-center">
                    <label class="text-[10px] font-medium text-gray-600">Dicke</label>
                    <input type="range" id="input-thickness" min="1" max="100" value="17.75" step="0.05" class="h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    <span id="disp-thickness" class="text-[10px] text-gray-500 font-mono text-right">17.8%</span>
                </div>
                <div class="grid grid-cols-[60px_1fr_35px] gap-2 items-center">
                    <label class="text-[10px] font-medium text-gray-600">Raster</label>
                    <input type="range" id="input-spacing" min="20" max="250" value="100" class="h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    <span id="disp-spacing" class="text-[10px] text-gray-500 font-mono text-right">100px</span>
                </div>
            </div>

            <div class="h-px bg-gray-100"></div>

            <!-- TIEFE -->
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="check-depth" class="w-3 h-3 text-teal-500 rounded border-gray-300 focus:ring-teal-500">
                    <label for="check-depth" class="text-[10px] font-bold text-gray-600 uppercase tracking-wider cursor-pointer">Tiefe (Weichzeichner)</label>
                </div>
                <div id="depth-controls" class="space-y-1.5 hidden pl-2 border-l-2 border-teal-100">
                    <div class="grid grid-cols-[60px_1fr_35px] gap-2 items-center">
                        <label class="text-[10px] text-gray-500">Stärke</label>
                        <input type="range" id="input-depth-strength" min="0" max="20" value="5" class="h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-teal-500">
                        <span id="disp-depth-strength" class="text-[10px] text-gray-500 font-mono text-right">5</span>
                    </div>
                    <div class="grid grid-cols-[60px_1fr_35px] gap-2 items-center">
                        <label class="text-[10px] text-gray-500">Start ab</label>
                        <input type="range" id="input-depth-threshold" min="1" max="3" step="0.1" value="1" class="h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-teal-500" title="Skalierungsfaktor ab dem der Blur beginnt">
                        <span id="disp-depth-threshold" class="text-[10px] text-gray-500 font-mono text-right">1.0x</span>
                    </div>
                </div>
            </div>

            <div class="h-px bg-gray-100"></div>

            <!-- Animation -->
            <div class="space-y-2">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="check-animation" class="w-3 h-3 text-orange-500 rounded border-gray-300 focus:ring-orange-500">
                        <label for="check-animation" class="text-[10px] font-bold text-gray-600 uppercase tracking-wider cursor-pointer">Animation</label>
                    </div>
                </div>
                <div id="anim-controls" class="space-y-1.5 hidden pl-2 border-l-2 border-orange-100">
                    <div class="grid grid-cols-[60px_1fr_35px] gap-2 items-center">
                        <label class="text-[10px] text-gray-500">Intensität</label>
                        <input type="range" id="input-anim-intensity" min="0" max="100" value="50" class="h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500">
                        <span id="disp-anim-intensity" class="text-[10px] text-gray-500 font-mono text-right">50%</span>
                    </div>
                    <div class="grid grid-cols-[60px_1fr_35px] gap-2 items-center">
                        <label class="text-[10px] text-gray-500">Zufall</label>
                        <input type="range" id="input-anim-random" min="0" max="100" value="20" class="h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500">
                        <span id="disp-anim-random" class="text-[10px] text-gray-500 font-mono text-right">20%</span>
                    </div>
                    <div class="grid grid-cols-[60px_1fr_35px] gap-2 items-center">
                        <label class="text-[10px] text-gray-500">Tempo</label>
                        <input type="range" id="input-anim-speed" min="1" max="50" value="15" class="h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500">
                        <span id="disp-anim-speed" class="text-[10px] text-gray-500 font-mono text-right">1.5x</span>
                    </div>
                </div>
            </div>

            <div class="h-px bg-gray-100"></div>

            <!-- FARBE & VERLAUF -->
            <div class="space-y-3">
                <h2 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Farbe & Verlauf</h2>
                
                <!-- HINTERGRUND Sektion -->
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-700 block">Farbe Hintergrund</label>
                    <div class="flex items-center gap-2">
                        <input type="color" id="input-color-1" value="#1500FF" class="w-6 h-6 rounded border-0 cursor-pointer p-0 bg-transparent flex-shrink-0">
                        <div id="color-2-container" class="hidden flex items-center gap-2">
                            <span class="text-gray-300">→</span>
                            <input type="color" id="input-color-2" value="#000000" class="w-6 h-6 rounded border-0 cursor-pointer p-0 bg-transparent flex-shrink-0">
                        </div>
                        <div class="flex-1"></div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="check-gradient" class="w-3 h-3 text-purple-600 rounded border-gray-300">
                            <label for="check-gradient" class="text-[10px] text-gray-500 cursor-pointer">Verlauf</label>
                        </div>
                    </div>
                    <div id="gradient-edit-container" class="hidden flex justify-end">
                        <div class="flex items-center space-x-1">
                            <input type="checkbox" id="check-grad-edit" class="w-3 h-3 text-purple-600 rounded border-gray-300">
                            <label for="check-grad-edit" class="text-[10px] text-gray-500 cursor-pointer">Richtung</label>
                        </div>
                    </div>
                </div>

                <div class="h-px bg-gray-50 border-t border-dashed border-gray-200"></div>

                <!-- PLUS FARBE Sektion -->
                <div class="space-y-1">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="check-plus-color" class="w-3 h-3 text-indigo-600 rounded border-gray-300">
                            <label for="check-plus-color" class="text-[10px] font-bold text-gray-700 cursor-pointer">Farbe Plus</label>
                        </div>
                    </div>
                    
                    <div id="plus-color-controls" class="hidden pl-2 border-l-2 border-indigo-100 mt-1 space-y-1">
                        <div class="flex items-center gap-2">
                            <input type="color" id="input-plus-col-1" value="#ffffff" class="w-5 h-5 rounded border-0 cursor-pointer p-0 bg-transparent flex-shrink-0">
                            <div id="plus-col-2-container" class="hidden flex items-center gap-2">
                                <span class="text-gray-300">→</span>
                                <input type="color" id="input-plus-col-2" value="#dddddd" class="w-5 h-5 rounded border-0 cursor-pointer p-0 bg-transparent flex-shrink-0">
                            </div>
                            <div class="flex-1"></div>
                            <div class="flex items-center space-x-1">
                                <input type="checkbox" id="check-plus-gradient" class="w-3 h-3 text-indigo-600 rounded border-gray-300">
                                <label for="check-plus-gradient" class="text-[9px] text-gray-500 cursor-pointer">Verlauf</label>
                            </div>
                        </div>
                        <div id="plus-gradient-edit-container" class="hidden flex justify-end">
                            <div class="flex items-center space-x-1">
                                <input type="checkbox" id="check-plus-grad-edit" class="w-3 h-3 text-indigo-600 rounded border-gray-300">
                                <label for="check-plus-grad-edit" class="text-[9px] text-gray-500 cursor-pointer">Richtung</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="h-px bg-gray-100"></div>

            <!-- Hintergrund Bild -->
            <div class="space-y-2">
                <div class="flex justify-between items-center">
                    <h2 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Bild (Drag&Drop)</h2>
                    <div class="flex items-center space-x-1">
                        <input type="checkbox" id="check-bg-edit" disabled class="w-3 h-3 text-blue-600 rounded border-gray-300 disabled:opacity-50">
                        <label id="label-bg-edit" for="check-bg-edit" class="text-[10px] text-gray-500 cursor-pointer opacity-50">Edit</label>
                    </div>
                </div>
                
                <div id="bg-controls" class="space-y-1.5 opacity-50 pointer-events-none transition-opacity">
                    <div class="grid grid-cols-[60px_1fr_35px] gap-2 items-center">
                        <label class="text-[10px] text-gray-500">Zoom</label>
                        <input type="range" id="input-bg-scale" min="0.1" max="5" step="0.1" value="1" class="h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600">
                        <span id="disp-bg-scale" class="text-[10px] text-gray-500 font-mono text-right">1.0x</span>
                    </div>
                    <div class="grid grid-cols-[60px_1fr_35px] gap-2 items-center">
                        <label class="text-[10px] text-gray-500">Opazität</label>
                        <input type="range" id="input-bg-opacity" min="0" max="100" value="100" class="h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-pink-600">
                        <span id="disp-bg-opacity" class="text-[10px] text-gray-500 font-mono text-right">100%</span>
                    </div>
                    <div class="flex items-center justify-between pt-1">
                        <div class="flex items-center space-x-1">
                            <input type="checkbox" id="check-bg-mono" class="w-3 h-3 text-gray-600 rounded border-gray-300 focus:ring-gray-500">
                            <label for="check-bg-mono" class="text-[10px] text-gray-500 cursor-pointer">Monochrom</label>
                        </div>
                        <div class="flex items-center space-x-1">
                            <input type="checkbox" id="check-bg-multiply" class="w-3 h-3 text-pink-600 rounded border-gray-300 focus:ring-pink-500">
                            <label for="check-bg-multiply" class="text-[10px] text-gray-500 cursor-pointer">Multiplizieren</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="h-px bg-gray-100"></div>

            <!-- Raster Editiermodus -->
            <div class="space-y-2">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="check-edit-mode" class="w-3 h-3 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                    <label for="check-edit-mode" class="text-[10px] font-bold text-gray-600 uppercase tracking-wider cursor-pointer">Mal-Modus</label>
                </div>
                
                <div id="edit-mode-controls" class="space-y-2 hidden">
                    <div class="flex space-x-3 p-1.5 bg-gray-50 rounded border border-gray-100">
                        <div class="flex items-center space-x-1"><input type="checkbox" id="check-paint-scale" checked class="w-3 h-3 text-blue-600 rounded"><label for="check-paint-scale" class="text-[10px] cursor-pointer">Size</label></div>
                        <div class="flex items-center space-x-1"><input type="checkbox" id="check-paint-thickness" class="w-3 h-3 text-blue-600 rounded"><label for="check-paint-thickness" class="text-[10px] cursor-pointer">Thick</label></div>
                    </div>
                    <div class="grid grid-cols-[60px_1fr_35px] gap-2 items-center">
                        <label class="text-[10px] text-gray-500">Pinsel</label>
                        <input type="range" id="input-brush-size" min="20" max="500" value="100" class="h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        <span id="disp-brush-size" class="text-[10px] text-gray-500 font-mono text-right">100px</span>
                    </div>
                    <div class="flex gap-1">
                        <button id="btn-tool-plus" class="tool-btn active flex-1 py-1 border border-gray-200 rounded text-xs font-bold hover:bg-gray-100 transition-colors">+</button>
                        <button id="btn-tool-minus" class="tool-btn flex-1 py-1 border border-gray-200 rounded text-xs font-bold hover:bg-gray-100 transition-colors">-</button>
                        <button id="btn-tool-delete" class="tool-btn flex-1 py-1 border border-gray-200 rounded text-xs font-bold hover:bg-gray-100 transition-colors text-red-500">X</button>
                    </div>
                    <div class="flex items-center space-x-1 justify-end">
                        <input type="checkbox" id="check-influence" class="w-3 h-3 text-blue-600 rounded border-gray-300">
                        <label for="check-influence" class="text-[10px] text-gray-500 cursor-pointer">Soft</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer / Export fixed bottom -->
        <div class="p-3 border-t border-gray-200 bg-gray-50 shrink-0 space-y-2">
            <!-- Format Auswahl & Checkbox -->
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <select id="input-export-format" class="text-[10px] border-gray-300 rounded bg-white text-gray-600 py-0.5 pl-1 pr-4 h-6 border focus:ring-0 focus:border-blue-500 cursor-pointer">
                        <option value="svg">SVG (Vektor)</option>
                        <option value="png">PNG (Raster + Blur)</option>
                    </select>
                </div>
                <div class="flex items-center space-x-1">
                    <input type="checkbox" id="check-export-bg" checked class="w-3 h-3 text-blue-600 rounded border-gray-300">
                    <label for="check-export-bg" class="text-[10px] text-gray-500 cursor-pointer">Mit BG</label>
                </div>
            </div>
            <div class="flex justify-between items-center">
                 <span class="text-[9px] text-gray-400" id="stat-items">0 Items</span>
                 <button id="btn-export" class="flex-1 ml-2 py-1.5 px-4 bg-gray-900 hover:bg-gray-800 text-white text-xs font-bold rounded shadow transition-colors">Export</button>
            </div>
        </div>
    </aside>

    <main id="main-area" class="flex-1 flex items-center justify-center relative">
        <!-- INTRO LAYER -->
        <div id="intro-layer">
            <!-- Updated Combined SVG with Group Translate Removed -->
            <svg id="intro-svg" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 1920 1080">
                <g id="intro-group">
                    <!-- Rest -->
                    <path id="intro-logo-rest" d="M1474.62,414.34c-45.54-87.33-136.83-147.09-242.17-147.09h-321.39v96.71h321.38c48,0,91.48,19.25,123.27,50.38,32.64,31.96,52.96,76.43,52.96,125.66,0,57.09-27.37,107.72-69.58,139.89-29.63,22.58-66.52,36.15-106.64,36.15h-544.88c-39.28,0-75.45-13.02-104.76-34.75-43.28-32.09-71.46-83.35-71.46-141.29,0-97.17,78.94-176.04,176.22-176.04h112.05v-96.71h-112.05c-150.75,0-273.06,122.17-273.06,272.75,0,51.49,14.99,99.85,40.48,141.29,48.14,78.28,134.41,131.47,232.58,131.47h544.89c98.92,0,185.76-53.61,233.68-132.87,24.81-41.04,39.38-88.83,39.38-139.89,0-45.35-11.26-88.03-30.88-125.66Z" fill="#ffffff"/>
                    <!-- Plus -->
                    <polygon id="intro-plus-poly" points="1008.42 679.88 1008.42 588.36 1232.73 588.36 1232.73 491.64 1008.42 491.64 1008.42 414.34 1008.42 363.96 1008.42 267.25 911.59 267.25 911.59 491.64 687.33 491.64 687.33 588.36 911.59 588.36 911.59 716.04 911.34 716.04 911.34 812.75 1008.42 812.75 1008.42 716.04 1008.42 679.88" fill="#ffffff"/>
                </g>
            </svg>
        </div>

        <button id="btn-toggle-menu" class="bg-white p-1.5 rounded shadow-sm hover:bg-gray-50 text-gray-500"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
        <div id="drop-overlay">Bild hier ablegen</div>
        <div id="bg-layer"><img id="bg-image-element" src="" alt="Background"></div>
        <div id="grid-container"></div>
        <div id="ui-layer">
            <svg id="grad-line-svg"><line id="grad-line-visual" x1="0" y1="0" x2="0" y2="0" stroke="white" stroke-width="2" stroke-dasharray="4" /><circle id="grad-start-point" cx="0" cy="0" r="4" fill="white" /><circle id="grad-end-point" cx="0" cy="0" r="4" fill="white" /></svg>
            <div id="brush-cursor"></div>
        </div>
    </main>

    <script>
        const state = {
            size: 30, thicknessPercent: 17.75, spacing: 100,
            animation: { active: false, intensity: 0.5, randomness: 0.2, speed: 1.5, startTime: 0 },
            depth: { active: false, strength: 5, threshold: 1.0 },
            plusColor: { active: false, gradient: false, col1: '#ffffff', col2: '#dddddd' },
            // New State for Plus Gradient Editing
            plusGradientAngle: 45,
            isEditingPlusGrad: false,
            
            isPaintMode: false, brushSize: 100, activeTool: 'plus', useInfluence: false,
            modifiedCells: new Map(), isPainting: false, paintTargetScale: true, paintTargetThickness: false,
            bgColor1: '#1500FF', bgColor2: '#000000', hasGradient: false, gradientAngle: 225, 
            bgImageSrc: null, bgX: 0, bgY: 0, bgScale: 1, bgMultiply: false, bgOpacity: 100, bgMono: false, 
            isEditingBg: false, isEditingGrad: false, isDragging: false, startX: 0, startY: 0, lastMouseX: 0, lastMouseY: 0, mouseX: 0, mouseY: 0 
        };

        let gridCache = [];

        const ui = {
            root: document.documentElement, mainArea: document.getElementById('main-area'), dropOverlay: document.getElementById('drop-overlay'), gridContainer: document.getElementById('grid-container'),
            sidebar: document.getElementById('sidebar'), btnToggleMenu: document.getElementById('btn-toggle-menu'), btnCloseSidebar: document.getElementById('btn-close-sidebar'), btnRandom: document.getElementById('btn-random'),
            introLayer: document.getElementById('intro-layer'), introSvg: document.getElementById('intro-svg'), introRestPath: document.getElementById('intro-logo-rest'),
            checkAnimation: document.getElementById('check-animation'), animControls: document.getElementById('anim-controls'),
            inputAnimIntensity: document.getElementById('input-anim-intensity'), inputAnimRandom: document.getElementById('input-anim-random'), inputAnimSpeed: document.getElementById('input-anim-speed'),
            checkDepth: document.getElementById('check-depth'), depthControls: document.getElementById('depth-controls'), 
            inputDepthStrength: document.getElementById('input-depth-strength'), inputDepthThreshold: document.getElementById('input-depth-threshold'),
            checkEditMode: document.getElementById('check-edit-mode'), editModeControls: document.getElementById('edit-mode-controls'),
            checkPaintScale: document.getElementById('check-paint-scale'), checkPaintThickness: document.getElementById('check-paint-thickness'),
            inputBrushSize: document.getElementById('input-brush-size'),
            btnToolPlus: document.getElementById('btn-tool-plus'), btnToolMinus: document.getElementById('btn-tool-minus'), btnToolDelete: document.getElementById('btn-tool-delete'),
            checkInfluence: document.getElementById('check-influence'), brushCursor: document.getElementById('brush-cursor'),
            inputSize: document.getElementById('input-size'), inputThickness: document.getElementById('input-thickness'), inputSpacing: document.getElementById('input-spacing'),
            inputColor1: document.getElementById('input-color-1'), inputColor2: document.getElementById('input-color-2'), 
            color2Container: document.getElementById('color-2-container'), gradientEditContainer: document.getElementById('gradient-edit-container'),
            checkGradient: document.getElementById('check-gradient'), checkGradEdit: document.getElementById('check-grad-edit'),
            checkPlusColor: document.getElementById('check-plus-color'), plusColorControls: document.getElementById('plus-color-controls'),
            inputPlusCol1: document.getElementById('input-plus-col-1'), inputPlusCol2: document.getElementById('input-plus-col-2'),
            plusCol2Container: document.getElementById('plus-col-2-container'), checkPlusGradient: document.getElementById('check-plus-gradient'),
            plusGradientEditContainer: document.getElementById('plus-gradient-edit-container'), checkPlusGradEdit: document.getElementById('check-plus-grad-edit'),
            gradLineSvg: document.getElementById('grad-line-svg'), gradLineVisual: document.getElementById('grad-line-visual'), gradStartPoint: document.getElementById('grad-start-point'), gradEndPoint: document.getElementById('grad-end-point'),
            checkBgEdit: document.getElementById('check-bg-edit'), labelBgEdit: document.getElementById('label-bg-edit'), bgControls: document.getElementById('bg-controls'),
            inputBgScale: document.getElementById('input-bg-scale'), checkBgMultiply: document.getElementById('check-bg-multiply'), checkBgMono: document.getElementById('check-bg-mono'), inputBgOpacity: document.getElementById('input-bg-opacity'), bgImageElement: document.getElementById('bg-image-element'),
            checkExportBg: document.getElementById('check-export-bg'), btnExport: document.getElementById('btn-export'), inputExportFormat: document.getElementById('input-export-format'),
            valSize: document.getElementById('val-size'), valThicknessPercent: document.getElementById('val-thickness-percent'), valSpacing: document.getElementById('val-spacing'), statItems: document.getElementById('stat-items'),
            labelSize: document.getElementById('label-size'),
            dispSize: document.getElementById('disp-size'), dispThickness: document.getElementById('disp-thickness'), dispSpacing: document.getElementById('disp-spacing'),
            dispDepthStrength: document.getElementById('disp-depth-strength'), dispDepthThreshold: document.getElementById('disp-depth-threshold'),
            dispAnimIntensity: document.getElementById('disp-anim-intensity'), dispAnimRandom: document.getElementById('disp-anim-random'), dispAnimSpeed: document.getElementById('disp-anim-speed'),
            dispBgScale: document.getElementById('disp-bg-scale'), dispBgOpacity: document.getElementById('disp-bg-opacity'), dispBrushSize: document.getElementById('disp-brush-size'),
        };

        function simpleHash(x, y) { return Math.sin(x * 12.9898 + y * 78.233) * 43758.5453123 - Math.floor(Math.sin(x * 12.9898 + y * 78.233) * 43758.5453123); }

        function animationLoop() {
            if (!state.animation.active) return;
            const t = (performance.now() * 0.001 * state.animation.speed);
            const intensity = state.animation.intensity;
            const randomness = state.animation.randomness;

            const len = gridCache.length;
            for (let i = 0; i < len; i++) {
                const item = gridCache[i];
                const lx = item.x; const ly = item.y;
                let baseScale = item.paintScale;

                const w1 = Math.sin(lx * 0.15 + ly * 0.15 + t);
                const w2 = Math.cos(lx * 0.08 - t * 0.5);
                const w3 = Math.sin(ly * 0.3 + t * 1.5);
                
                const noise = simpleHash(lx, ly) * 2 - 1; 
                const localTime = t + (noise * randomness * 5.0);
                const breathe = (Math.sin(localTime) + Math.sin(localTime * 0.5 + lx*0.1)) / 2; 
                const delta = breathe * intensity * 8.0; 
                
                let animatedScaleFactor = (1 + delta);
                if (animatedScaleFactor < 0) animatedScaleFactor = 0;

                item.el.style.setProperty('--anim-scale', animatedScaleFactor.toFixed(3));
                
                if (state.depth.active) {
                    const totalScale = baseScale * animatedScaleFactor;
                    let blurPx = 0;
                    if (totalScale > state.depth.threshold) {
                        blurPx = (totalScale - state.depth.threshold) * state.depth.strength;
                    }
                    item.el.style.setProperty('--local-blur', `${blurPx.toFixed(1)}px`);
                }
            }
            requestAnimationFrame(animationLoop);
        }

        function calculateIntroScale() {
            const svgPlusHeight = 545.5; 
            const winW = window.innerWidth; const winH = window.innerHeight;
            const svgW = 1920; const svgH = 1080;
            const scaleX = winW / svgW; const scaleY = winH / svgH;
            const fitScale = Math.min(scaleX, scaleY);
            const renderedPlusHeight = svgPlusHeight * fitScale;
            return state.size / renderedPlusHeight;
        }

        window.addEventListener('load', () => {
            ui.introLayer.style.opacity = 1;
            setTimeout(() => {
                const targetScale = calculateIntroScale();
                ui.introSvg.style.transition = "transform 1.2s cubic-bezier(0.8, 0, 0.2, 1)";
                ui.introSvg.style.transform = `scale(${targetScale})`;
                setTimeout(() => { if(ui.introRestPath) ui.introRestPath.style.opacity = 0; }, 200);
                setTimeout(() => { ui.gridContainer.style.opacity = 1; }, 1200); 
                setTimeout(() => { ui.introLayer.style.backgroundColor = "transparent"; }, 1000);
                setTimeout(() => { ui.introLayer.style.opacity = 0; setTimeout(() => { ui.introLayer.style.display = 'none'; }, 500); }, 1400);
            }, 500);
        });

        function updateVisuals() {
            const absoluteThickness = (state.size * state.thicknessPercent) / 100;
            const activeGridSize = Math.max(state.spacing, state.size);
            const isGridExpanded = state.size > state.spacing;

            ui.root.style.setProperty('--size', `${state.size}px`);
            ui.root.style.setProperty('--thickness', `${absoluteThickness}px`);
            ui.root.style.setProperty('--grid-size', `${activeGridSize}px`);
            ui.root.style.setProperty('--bg-color-1', state.bgColor1);
            ui.root.style.setProperty('--bg-color-2', state.bgColor2);
            ui.root.style.setProperty('--bg-grad-angle', `${state.gradientAngle}deg`);
            ui.root.style.setProperty('--bg-blend', state.bgMultiply ? 'multiply' : 'normal');
            ui.root.style.setProperty('--bg-opacity', state.bgOpacity / 100);
            ui.root.style.setProperty('--bg-filter', state.bgMono ? 'grayscale(100%)' : 'none'); 
            ui.root.style.setProperty('--brush-size', `${state.brushSize}px`);
            
            if (state.plusColor.active) {
                if (state.plusColor.gradient) {
                    ui.root.style.setProperty('--plus-bg', `linear-gradient(${state.plusGradientAngle}deg, ${state.plusColor.col1}, ${state.plusColor.col2})`);
                } else {
                    ui.root.style.setProperty('--plus-bg', state.plusColor.col1);
                }
            } else {
                ui.root.style.setProperty('--plus-bg', '#ffffff');
            }

            if (state.hasGradient) { ui.mainArea.classList.add('has-gradient'); ui.color2Container.classList.remove('hidden'); ui.gradientEditContainer.classList.remove('hidden'); } else { ui.mainArea.classList.remove('has-gradient'); ui.color2Container.classList.add('hidden'); ui.gradientEditContainer.classList.add('hidden'); }
            
            if (state.plusColor.active) { 
                ui.plusColorControls.classList.remove('hidden'); 
                if (state.plusColor.gradient) { 
                    ui.plusCol2Container.classList.remove('hidden');
                    ui.plusGradientEditContainer.classList.remove('hidden');
                } else { 
                    ui.plusCol2Container.classList.add('hidden');
                    ui.plusGradientEditContainer.classList.add('hidden');
                }
            } else { 
                ui.plusColorControls.classList.add('hidden'); 
            }

            if(ui.valSize) ui.valSize.innerText = `${state.size}px`;
            if(ui.valThicknessPercent) ui.valThicknessPercent.innerText = `${state.thicknessPercent}%`;
            if(ui.valSpacing) ui.valSpacing.innerText = `${state.spacing}px`;

            if (isGridExpanded && ui.labelSize) ui.labelSize.classList.add('text-alert'); 
            else if (ui.labelSize) ui.labelSize.classList.remove('text-alert');

            if (!state.animation.active) {
                const len = gridCache.length;
                for(let i=0; i<len; i++) {
                    gridCache[i].el.style.setProperty('--anim-scale', 1);
                    if (state.depth.active) {
                        const s = gridCache[i].paintScale;
                        let blurPx = (s > state.depth.threshold) ? (s - state.depth.threshold) * state.depth.strength : 0;
                        gridCache[i].el.style.setProperty('--local-blur', `${blurPx.toFixed(1)}px`);
                    } else {
                        gridCache[i].el.style.setProperty('--local-blur', `0px`);
                    }
                }
            }
            recalcGridGeometry();
        }

        function updateCellVisual(item, data) {
            item.el.style.setProperty('--paint-scale', data.scale.toFixed(3));
            item.el.style.setProperty('--th-multi', data.thMulti);
            item.paintScale = data.scale;
            
            if (!state.animation.active) {
                if (state.depth.active && data.scale > state.depth.threshold) {
                    let blurPx = (data.scale - state.depth.threshold) * state.depth.strength;
                    item.el.style.setProperty('--local-blur', `${blurPx.toFixed(1)}px`);
                } else {
                    item.el.style.setProperty('--local-blur', `0px`);
                }
            }
        }
        
        function updatePaintLoop() { if (state.isPaintMode && state.isPainting) { applyBrush(state.mouseX, state.mouseY); requestAnimationFrame(updatePaintLoop); } }
        
        function applyBrush(mx, my) {
            const activeGridSize = Math.max(state.spacing, state.size);
            const gridRect = ui.gridContainer.getBoundingClientRect();
            const localMx = mx - gridRect.left; const localMy = my - gridRect.top;
            const radius = state.brushSize / 2; const radiusSq = radius * radius;
            const growthRate = 0.05; 

            const len = gridCache.length;
            for (let i = 0; i < len; i++) {
                const item = gridCache[i];
                const cell = item.el;
                const cx = cell.offsetLeft + (activeGridSize / 2); const cy = cell.offsetTop + (activeGridSize / 2);
                const dx = cx - localMx; const dy = cy - localMy;
                if (dx*dx + dy*dy < radiusSq) {
                    const key = item.key;
                    let d = state.modifiedCells.get(key) || { scale: 1.0, thMulti: 1.0 };
                    d = { ...d }; 
                    let inf = 1; 
                    if (state.useInfluence) { inf = 1 - (Math.sqrt(dx*dx + dy*dy) / radius); if (inf < 0) inf = 0; }
                    if (state.paintTargetScale) {
                        if (state.activeTool === 'plus') d.scale += growthRate * inf;
                        else if (state.activeTool === 'minus') { d.scale -= growthRate * inf; if(d.scale<0) d.scale=0; }
                        else if (state.activeTool === 'delete') d.scale = state.useInfluence ? d.scale*(1-(0.1*inf)) : 0;
                    }
                    if (state.paintTargetThickness) {
                        if (state.activeTool === 'plus') d.thMulti += growthRate * inf;
                        else if (state.activeTool === 'minus') { d.thMulti -= growthRate * inf; if(d.thMulti<0) d.thMulti=0; }
                        else if (state.activeTool === 'delete') d.thMulti = state.useInfluence ? d.thMulti*(1-(0.1*inf)) : 0;
                    }
                    state.modifiedCells.set(key, d);
                    updateCellVisual(item, d);
                }
            }
        }

        function recalcGridGeometry() {
            const activeGridSize = Math.max(state.spacing, state.size);
            const w = ui.mainArea.clientWidth || window.innerWidth;
            const h = ui.mainArea.clientHeight || window.innerHeight;
            const cols = Math.ceil((w * 1.2) / activeGridSize) + ((Math.ceil((w * 1.2) / activeGridSize) % 2 === 0) ? 5 : 4);
            const rows = Math.ceil((h * 1.2) / activeGridSize) + ((Math.ceil((h * 1.2) / activeGridSize) % 2 === 0) ? 5 : 4);
            ui.root.style.setProperty('--col-count', cols);
            const total = cols * rows; const safe = Math.min(total, 5000);
            if(ui.statItems) ui.statItems.innerText = safe + " Items";
            if (ui.gridContainer.childElementCount !== safe || ui.gridContainer.dataset.cols != cols) {
                renderGridItems(safe, cols, rows);
                ui.gridContainer.dataset.cols = cols;
            }
        }

        function renderGridItems(count, cols, rows) {
            const frag = document.createDocumentFragment();
            ui.gridContainer.innerHTML = '';
            gridCache = [];
            const cc = Math.floor(cols / 2); const cr = Math.floor(rows / 2);
            for (let i = 0; i < count; i++) {
                const c = i % cols; const r = Math.floor(i / cols);
                const lx = c - cc; const ly = r - cr;
                const div = document.createElement('div');
                div.className = 'plus-shape'; div.dataset.x = lx; div.dataset.y = ly;
                const h = document.createElement('div'); h.className = 'bar-h';
                const v = document.createElement('div'); v.className = 'bar-v';
                div.appendChild(h); div.appendChild(v);
                const key = `${lx},${ly}`;
                const item = { el: div, x: lx, y: ly, key: key, paintScale: 1.0 };
                gridCache.push(item);
                if (state.modifiedCells.has(key)) { const d = state.modifiedCells.get(key); updateCellVisual(item, d); }
                frag.appendChild(div);
            }
            ui.gridContainer.appendChild(frag);
        }

        function updateBgTransform() { ui.root.style.setProperty('--bg-x', `${state.bgX}px`); ui.root.style.setProperty('--bg-y', `${state.bgY}px`); ui.root.style.setProperty('--bg-scale', state.bgScale); }

        function updateInteractionStates() {
            if (state.isEditingGrad) {
                ui.mainArea.classList.add('is-editing-grad'); ui.mainArea.classList.remove('is-editing-bg'); 
                ui.checkBgEdit.disabled = true; if(ui.labelBgEdit) ui.labelBgEdit.classList.add('opacity-50');
                ui.checkPlusGradEdit.disabled = true;
            } else if (state.isEditingPlusGrad) {
                ui.mainArea.classList.add('is-editing-grad'); ui.mainArea.classList.remove('is-editing-bg');
                ui.checkBgEdit.disabled = true; if(ui.labelBgEdit) ui.labelBgEdit.classList.add('opacity-50');
                ui.checkGradEdit.disabled = true;
            } else {
                ui.mainArea.classList.remove('is-editing-grad');
                ui.checkGradEdit.disabled = false;
                ui.checkPlusGradEdit.disabled = false;
                if (state.bgImageSrc && !state.isPaintMode) { 
                    ui.checkBgEdit.disabled = false; if(ui.labelBgEdit) ui.labelBgEdit.classList.remove('opacity-50');
                    if (ui.checkBgEdit.checked) { ui.mainArea.classList.add('is-editing-bg'); ui.bgControls.classList.remove('opacity-50', 'pointer-events-none'); state.isEditingBg = true; }
                }
            }
            if ((!state.isEditingGrad && !state.isEditingPlusGrad) && state.isEditingBg && !state.isPaintMode) ui.mainArea.classList.add('is-editing-bg'); 
            else if (!state.isEditingGrad && !state.isEditingPlusGrad) ui.mainArea.classList.remove('is-editing-bg');
        }
        function deactivateGradientMode() { 
            state.isEditingGrad = false; ui.checkGradEdit.checked = false; 
            state.isEditingPlusGrad = false; ui.checkPlusGradEdit.checked = false;
            updateInteractionStates(); 
        }
        
        // RANDOMIZER LOGIC
        function randomizeConfig() {
            // Basic
            state.size = Math.floor(Math.random() * 200) + 20;
            state.thicknessPercent = (Math.random() * 80) + 5;
            state.spacing = Math.floor(Math.random() * 200) + 20;
            
            // Colors - generate random hex
            const rHex = () => '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            state.bgColor1 = rHex();
            state.bgColor2 = rHex();
            state.hasGradient = Math.random() > 0.5;
            state.gradientAngle = Math.floor(Math.random() * 360);
            
            state.plusColor.active = Math.random() > 0.3;
            state.plusColor.gradient = Math.random() > 0.5;
            state.plusColor.col1 = rHex();
            state.plusColor.col2 = rHex();
            state.plusGradientAngle = Math.floor(Math.random() * 360);
            
            // Animation
            state.animation.active = Math.random() > 0.6; // 40% chance active
            if(state.animation.active) {
                state.animation.intensity = Math.random();
                state.animation.speed = 0.5 + Math.random() * 3;
                state.animation.randomness = Math.random();
            }

            // Depth
            state.depth.active = Math.random() > 0.7;
            if(state.depth.active) {
                state.depth.strength = Math.floor(Math.random() * 15) + 1;
                state.depth.threshold = 0.5 + Math.random() * 2;
            }

            // Sync UI Inputs
            ui.inputSize.value = state.size;
            ui.inputThickness.value = state.thicknessPercent;
            ui.inputSpacing.value = state.spacing;
            
            ui.inputColor1.value = state.bgColor1;
            ui.inputColor2.value = state.bgColor2;
            ui.checkGradient.checked = state.hasGradient;
            
            ui.checkPlusColor.checked = state.plusColor.active;
            ui.checkPlusGradient.checked = state.plusColor.gradient;
            ui.inputPlusCol1.value = state.plusColor.col1;
            ui.inputPlusCol2.value = state.plusColor.col2;
            
            ui.checkAnimation.checked = state.animation.active;
            ui.inputAnimIntensity.value = state.animation.intensity * 100;
            ui.inputAnimRandom.value = state.animation.randomness * 100;
            ui.inputAnimSpeed.value = state.animation.speed * 10;
            if(state.animation.active) { ui.animControls.classList.remove('hidden'); animationLoop(); } else { ui.animControls.classList.add('hidden'); }
            
            ui.checkDepth.checked = state.depth.active;
            ui.inputDepthStrength.value = state.depth.strength;
            ui.inputDepthThreshold.value = state.depth.threshold;
            if(state.depth.active) ui.depthControls.classList.remove('hidden'); else ui.depthControls.classList.add('hidden');

            updateVisuals();
            // Update Display spans
            if(ui.dispSize) ui.dispSize.innerText = state.size + 'px';
            if(ui.dispThickness) ui.dispThickness.innerText = state.thicknessPercent.toFixed(1) + '%';
            if(ui.dispSpacing) ui.dispSpacing.innerText = state.spacing + 'px';
            // ... other displays update implicitly via listeners or updateVisuals if wired, but listeners only fire on user input.
            // Update spans manually for randomizer:
            if(ui.dispAnimIntensity) ui.dispAnimIntensity.innerText = Math.floor(state.animation.intensity*100) + '%';
            if(ui.dispAnimRandom) ui.dispAnimRandom.innerText = Math.floor(state.animation.randomness*100) + '%';
            if(ui.dispAnimSpeed) ui.dispAnimSpeed.innerText = state.animation.speed.toFixed(1) + 'x';
            if(ui.dispDepthStrength) ui.dispDepthStrength.innerText = state.depth.strength;
            if(ui.dispDepthThreshold) ui.dispDepthThreshold.innerText = state.depth.threshold.toFixed(1) + 'x';
        }

        ui.btnRandom.addEventListener('click', randomizeConfig);

        // Listeners
        ui.checkAnimation.addEventListener('change', e => { state.animation.active = e.target.checked; if(e.target.checked) { ui.animControls.classList.remove('hidden'); animationLoop(); } else { ui.animControls.classList.add('hidden'); updateVisuals(); } });
        ui.inputAnimIntensity.addEventListener('input', e => { state.animation.intensity = parseInt(e.target.value)/100; if(ui.dispAnimIntensity) ui.dispAnimIntensity.innerText=e.target.value+'%'; });
        ui.inputAnimRandom.addEventListener('input', e => { state.animation.randomness = parseInt(e.target.value)/100; if(ui.dispAnimRandom) ui.dispAnimRandom.innerText=e.target.value+'%'; });
        ui.inputAnimSpeed.addEventListener('input', e => { state.animation.speed = parseInt(e.target.value)/10; if(ui.dispAnimSpeed) ui.dispAnimSpeed.innerText=state.animation.speed+'x'; });
        
        ui.checkDepth.addEventListener('change', e => { state.depth.active = e.target.checked; if(e.target.checked) ui.depthControls.classList.remove('hidden'); else ui.depthControls.classList.add('hidden'); updateVisuals(); });
        ui.inputDepthStrength.addEventListener('input', e => { state.depth.strength = parseInt(e.target.value); if(ui.dispDepthStrength) ui.dispDepthStrength.innerText=state.depth.strength; updateVisuals(); });
        ui.inputDepthThreshold.addEventListener('input', e => { state.depth.threshold = parseFloat(e.target.value); if(ui.dispDepthThreshold) ui.dispDepthThreshold.innerText=state.depth.threshold+'x'; updateVisuals(); });

        ui.checkPlusColor.addEventListener('change', e => { state.plusColor.active = e.target.checked; updateVisuals(); });
        ui.checkPlusGradient.addEventListener('change', e => { state.plusColor.gradient = e.target.checked; updateVisuals(); });
        ui.inputPlusCol1.addEventListener('input', e => { state.plusColor.col1 = e.target.value; updateVisuals(); });
        ui.inputPlusCol2.addEventListener('input', e => { state.plusColor.col2 = e.target.value; updateVisuals(); });
        ui.checkPlusGradEdit.addEventListener('change', e => { 
            state.isEditingPlusGrad = e.target.checked; 
            if(e.target.checked) {
                // Disable other edits
                state.isEditingGrad = false; ui.checkGradEdit.checked = false;
                state.isEditingBg = false; ui.checkBgEdit.checked = false;
            }
            updateInteractionStates(); 
        });

        ui.checkEditMode.addEventListener('change', e => { state.isPaintMode = e.target.checked; if(e.target.checked) { ui.editModeControls.classList.remove('hidden'); ui.mainArea.classList.add('is-painting'); ui.brushCursor.style.display='block'; ui.checkBgEdit.checked=false; ui.checkGradEdit.checked=false; state.isEditingBg=false; state.isEditingGrad=false; } else { ui.editModeControls.classList.add('hidden'); ui.mainArea.classList.remove('is-painting'); ui.brushCursor.style.display='none'; } });
        ui.checkPaintScale.addEventListener('change', e => state.paintTargetScale = e.target.checked);
        ui.checkPaintThickness.addEventListener('change', e => state.paintTargetThickness = e.target.checked);
        ui.inputBrushSize.addEventListener('input', e => { state.brushSize = parseInt(e.target.value); if(ui.dispBrushSize) ui.dispBrushSize.innerText=state.brushSize+'px'; updateVisuals(); });
        ui.checkInfluence.addEventListener('change', e => state.useInfluence = e.target.checked);
        
        ui.btnToolPlus.addEventListener('click', () => setTool('plus')); ui.btnToolMinus.addEventListener('click', () => setTool('minus')); ui.btnToolDelete.addEventListener('click', () => setTool('delete'));
        function setTool(t) { state.activeTool = t; ui.btnToolPlus.classList.remove('active'); ui.btnToolMinus.classList.remove('active'); ui.btnToolDelete.classList.remove('active'); if(t==='plus') ui.btnToolPlus.classList.add('active'); if(t==='minus') ui.btnToolMinus.classList.add('active'); if(t==='delete') ui.btnToolDelete.classList.add('active'); }

        ui.inputSize.addEventListener('input', e => { state.size = parseInt(e.target.value); if(ui.dispSize) ui.dispSize.innerText=state.size+'px'; updateVisuals(); });
        ui.inputThickness.addEventListener('input', e => { state.thicknessPercent = parseFloat(e.target.value); if(ui.dispThickness) ui.dispThickness.innerText=parseFloat(e.target.value).toFixed(1)+'%'; updateVisuals(); });
        ui.inputSpacing.addEventListener('input', e => { state.spacing = parseInt(e.target.value); if(ui.dispSpacing) ui.dispSpacing.innerText=state.spacing+'px'; updateVisuals(); });
        ui.inputColor1.addEventListener('input', e => { state.bgColor1 = e.target.value; deactivateGradientMode(); updateVisuals(); });
        ui.inputColor2.addEventListener('input', e => { state.bgColor2 = e.target.value; deactivateGradientMode(); updateVisuals(); });
        ui.checkGradient.addEventListener('change', e => { state.hasGradient = e.target.checked; updateVisuals(); });
        
        function toggleSidebar() { ui.sidebar.classList.toggle('collapsed'); setTimeout(recalcGridGeometry, 310); }
        ui.btnToggleMenu.addEventListener('click', toggleSidebar);
        ui.btnCloseSidebar.addEventListener('click', toggleSidebar);

        ui.inputBgScale.addEventListener('input', e => { state.bgScale = parseFloat(e.target.value); if(ui.dispBgScale) ui.dispBgScale.innerText=state.bgScale+'x'; updateBgTransform(); });
        ui.checkBgMultiply.addEventListener('change', e => { state.bgMultiply = e.target.checked; updateVisuals(); });
        ui.checkBgMono.addEventListener('change', e => { state.bgMono = e.target.checked; updateVisuals(); });
        ui.inputBgOpacity.addEventListener('input', e => { state.bgOpacity = parseInt(e.target.value); if(ui.dispBgOpacity) ui.dispBgOpacity.innerText=state.bgOpacity+'%'; updateVisuals(); });
        ui.checkGradEdit.addEventListener('change', e => { 
            state.isEditingGrad = e.target.checked; 
            if(e.target.checked) {
                 // disable other edit modes
                 state.isEditingPlusGrad = false; ui.checkPlusGradEdit.checked = false;
            }
            updateInteractionStates(); 
        });
        ui.checkBgEdit.addEventListener('change', e => { 
            state.isEditingBg = e.target.checked; 
            if (e.target.checked) ui.bgControls.classList.remove('opacity-50', 'pointer-events-none'); 
            else ui.bgControls.classList.add('opacity-50', 'pointer-events-none'); 
            updateInteractionStates(); 
        });

        ui.mainArea.addEventListener('pointermove', e => {
            const rect = ui.mainArea.getBoundingClientRect(); state.mouseX = e.clientX; state.mouseY = e.clientY;
            ui.root.style.setProperty('--brush-x', `${e.clientX - rect.left}px`); ui.root.style.setProperty('--brush-y', `${e.clientY - rect.top}px`);
            
            if (!state.isPaintMode && state.isDragging) {
                // Gradient Editing
                if (state.isEditingGrad || state.isEditingPlusGrad) {
                    const dx = e.clientX - state.startX; const dy = e.clientY - state.startY;
                    const currentRelX = e.clientX - rect.left; const currentRelY = e.clientY - rect.top;
                    ui.gradLineVisual.setAttribute('x2', currentRelX); ui.gradLineVisual.setAttribute('y2', currentRelY);
                    ui.gradEndPoint.setAttribute('cx', currentRelX); ui.gradEndPoint.setAttribute('cy', currentRelY);
                    const rad = Math.atan2(dy, dx); let deg = rad * (180 / Math.PI) + 90; 
                    
                    if (state.isEditingGrad) state.gradientAngle = Math.round(deg);
                    else state.plusGradientAngle = Math.round(deg);
                    
                    updateVisuals();
                } else if (state.isEditingBg && state.bgImageSrc) {
                    const dx = e.clientX - state.lastMouseX; const dy = e.clientY - state.lastMouseY;
                    state.bgX += dx; state.bgY += dy; state.lastMouseX = e.clientX; state.lastMouseY = e.clientY; updateBgTransform();
                }
            }
        });
        ui.mainArea.addEventListener('pointerdown', e => { 
            if(state.isPaintMode) { state.isPainting=true; updatePaintLoop(); applyBrush(e.clientX, e.clientY); } 
            else {
                state.isDragging = true; state.startX = e.clientX; state.startY = e.clientY;
                if (state.isEditingGrad || state.isEditingPlusGrad) {
                    const rect = ui.mainArea.getBoundingClientRect(); const relX = e.clientX - rect.left; const relY = e.clientY - rect.top;
                    ui.gradLineVisual.style.display = 'block'; ui.gradLineSvg.style.display = 'block'; 
                    ui.gradLineVisual.setAttribute('x1', relX); ui.gradLineVisual.setAttribute('y1', relY); ui.gradLineVisual.setAttribute('x2', relX); ui.gradLineVisual.setAttribute('y2', relY); ui.gradStartPoint.setAttribute('cx', relX); ui.gradStartPoint.setAttribute('cy', relY); ui.gradEndPoint.setAttribute('cx', relX); ui.gradEndPoint.setAttribute('cy', relY);
                } else if (state.isEditingBg) { state.lastMouseX = e.clientX; state.lastMouseY = e.clientY; }
            }
        });
        window.addEventListener('pointerup', () => { state.isDragging = false; state.isPainting = false; if (state.isEditingGrad || state.isEditingPlusGrad) ui.gradLineSvg.style.display = 'none'; });
        window.addEventListener('resize', () => recalcGridGeometry());

        // -- DRAG & DROP --
        let dragCounter = 0;
        function handleDragEnter(e) { e.preventDefault(); e.stopPropagation(); dragCounter++; if (dragCounter > 0) ui.dropOverlay.style.display = 'flex'; }
        function handleDragLeave(e) { e.preventDefault(); e.stopPropagation(); dragCounter--; if (dragCounter <= 0) { ui.dropOverlay.style.display = 'none'; dragCounter = 0; } }
        function handleDragOver(e) { e.preventDefault(); e.stopPropagation(); }
        function handleDrop(e) {
            e.preventDefault(); e.stopPropagation(); dragCounter = 0; ui.dropOverlay.style.display = 'none';
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.onload = () => {
                        state.bgImageSrc = evt.target.result; ui.bgImageElement.src = state.bgImageSrc; ui.bgImageElement.style.display = 'block';
                        const scaleW = ui.mainArea.clientWidth / img.width; const scaleH = ui.mainArea.clientHeight / img.height;
                        const initialScale = Math.max(scaleW, scaleH); state.bgScale = initialScale; state.bgX = 0; state.bgY = 0;
                        ui.inputBgScale.value = initialScale; updateBgTransform(); ui.checkBgEdit.disabled = false; if(ui.labelBgEdit) ui.labelBgEdit.classList.remove('opacity-50');
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(files[0]);
            }
        }
        window.addEventListener('dragenter', handleDragEnter); window.addEventListener('dragleave', handleDragLeave); window.addEventListener('dragover', handleDragOver); window.addEventListener('drop', handleDrop);

        // --- PNG EXPORT FUNCTION ---
        function downloadPNG() {
            const canvas = document.createElement('canvas'); const w = ui.mainArea.clientWidth; const h = ui.mainArea.clientHeight; canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d');
            if (ui.checkExportBg.checked) {
                if (state.hasGradient) {
                    const angleRad = (state.gradientAngle - 90) * (Math.PI / 180); const halfDiag = Math.sqrt(w*w + h*h) / 2; const cx = w/2; const cy = h/2;
                    const x0 = cx - Math.cos(angleRad) * halfDiag; const y0 = cy - Math.sin(angleRad) * halfDiag; const x1 = cx + Math.cos(angleRad) * halfDiag; const y1 = cy + Math.sin(angleRad) * halfDiag;
                    const grad = ctx.createLinearGradient(x0, y0, x1, y1); grad.addColorStop(0, state.bgColor1); grad.addColorStop(1, state.bgColor2); ctx.fillStyle = grad;
                } else { ctx.fillStyle = state.bgColor1; }
                ctx.fillRect(0, 0, w, h);
                if (state.bgImageSrc && ui.bgImageElement) {
                    const img = ui.bgImageElement; const naturalW = img.naturalWidth; const naturalH = img.naturalHeight;
                    ctx.save(); ctx.translate(w/2 + state.bgX, h/2 + state.bgY); ctx.scale(state.bgScale, state.bgScale);
                    ctx.globalAlpha = state.bgOpacity / 100; if (state.bgMultiply) ctx.globalCompositeOperation = 'multiply'; if (state.bgMono) ctx.filter = 'grayscale(100%)';
                    ctx.drawImage(img, -naturalW/2, -naturalH/2); ctx.restore();
                }
            }
            const activeGridSize = Math.max(state.spacing, state.size); const bS = state.size; const bT = (state.size * state.thicknessPercent) / 100; const cx = w / 2; const cy = h / 2;
            const cols = Math.ceil((w * 1.2) / activeGridSize) + 4; const rows = Math.ceil((h * 1.2) / activeGridSize) + 4;
            const startCol = -Math.floor(cols/2); const endCol = Math.floor(cols/2); const startRow = -Math.floor(rows/2); const endRow = Math.floor(rows/2);
            
            // Plus Fill for Canvas
            if (state.plusColor.active) {
                if (state.plusColor.gradient) {
                    const angleRad = (state.plusGradientAngle - 90) * (Math.PI / 180); const halfDiag = Math.sqrt(w*w + h*h) / 2; 
                    const x0 = cx - Math.cos(angleRad) * halfDiag; const y0 = cy - Math.sin(angleRad) * halfDiag; const x1 = cx + Math.cos(angleRad) * halfDiag; const y1 = cy + Math.sin(angleRad) * halfDiag;
                    const grad = ctx.createLinearGradient(x0, y0, x1, y1); grad.addColorStop(0, state.plusColor.col1); grad.addColorStop(1, state.plusColor.col2); ctx.fillStyle = grad;
                } else { ctx.fillStyle = state.plusColor.col1; }
            } else { ctx.fillStyle = '#ffffff'; }

            for(let x=startCol; x<=endCol; x++) {
                for(let y=startRow; y<=endRow; y++) {
                    const px = cx + x * activeGridSize; const py = cy + y * activeGridSize;
                    let s = 1.0; let t = 1.0; const k = `${x},${y}`;
                    if(state.modifiedCells.has(k)) { const d = state.modifiedCells.get(k); s = d.scale; t = d.thMulti; }
                    if (s > 0.05) {
                        ctx.save();
                        if (state.depth.active && s > state.depth.threshold) { const blurPx = (s - state.depth.threshold) * state.depth.strength; if (blurPx > 0) ctx.filter = `blur(${blurPx}px)`; }
                        const cS = bS * s; const cT = bT * t * s;
                        ctx.fillRect(px - cS/2, py - cT/2, cS, cT); ctx.fillRect(px - cT/2, py - cS/2, cT, cS);
                        ctx.restore();
                    }
                }
            }
            const url = canvas.toDataURL('image/png'); const a = document.createElement('a'); a.href = url; a.download = 'raster_export.png'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // --- SVG EXPORT FUNCTION ---
        function downloadSVG() {
            const w = ui.mainArea.clientWidth; const h = ui.mainArea.clientHeight; const bS = state.size; const bT = (state.size * state.thicknessPercent) / 100;
            let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">`;
            let defs = "";
            if (state.hasGradient) defs += `<linearGradient id="gBg" gradientTransform="rotate(${state.gradientAngle-90}, 0.5, 0.5)"><stop offset="0%" stop-color="${state.bgColor1}"/><stop offset="100%" stop-color="${state.bgColor2}"/></linearGradient>`;
            if (state.plusColor.active && state.plusColor.gradient) { defs += `<linearGradient id="gPlus" gradientTransform="rotate(${state.plusGradientAngle-90}, 0.5, 0.5)"><stop offset="0%" stop-color="${state.plusColor.col1}"/><stop offset="100%" stop-color="${state.plusColor.col2}"/></linearGradient>`; }
            if(defs) svg += `<defs>${defs}</defs>`;
            if (ui.checkExportBg.checked) {
                if (state.hasGradient) svg += `<rect width="100%" height="100%" fill="url(#gBg)"/>`; else svg += `<rect width="100%" height="100%" fill="${state.bgColor1}"/>`; 
                if (state.bgImageSrc) {
                    const nw = ui.bgImageElement.naturalWidth; const nh = ui.bgImageElement.naturalHeight;
                    let styleStr = ""; if (state.bgMultiply) styleStr += "mix-blend-mode: multiply; "; if (state.bgMono) styleStr += "filter: grayscale(100%); ";
                    svg += `<g transform="translate(${w/2 + state.bgX}, ${h/2 + state.bgY}) scale(${state.bgScale})" style="${styleStr}" opacity="${state.bgOpacity/100}"><image href="${state.bgImageSrc}" x="${-nw/2}" y="${-nh/2}" width="${nw}" height="${nh}"/></g>`;
                }
            }
            const ags = Math.max(state.spacing, state.size); const cx = w/2; const cy = h/2;
            const cols = Math.ceil((w * 1.2) / ags) + 4; const rows = Math.ceil((h * 1.2) / ags) + 4;
            const startCol = -Math.floor(cols/2); const endCol = Math.floor(cols/2); const startRow = -Math.floor(rows/2); const endRow = Math.floor(rows/2);
            let plusFill = 'fill="#ffffff"'; if (state.plusColor.active) { if (state.plusColor.gradient) plusFill = 'fill="url(#gPlus)"'; else plusFill = `fill="${state.plusColor.col1}"`; }
            svg += `<g ${plusFill}>`;
            for(let x=startCol; x<=endCol; x++) for(let y=startRow; y<=endRow; y++) {
                const px = cx + x*ags; const py = cy + y*ags;
                let s = 1.0; let t = 1.0; const k = `${x},${y}`; if(state.modifiedCells.has(k)) { const d=state.modifiedCells.get(k); s=d.scale; t=d.thMulti; }
                if (s > 0.05) { const cS = bS * s; const cT = bT * t * s; svg += `<rect x="${px-cS/2}" y="${py-cT/2}" width="${cS}" height="${cT}"/><rect x="${px-cT/2}" y="${py-cS/2}" width="${cT}" height="${cS}"/>`; }
            }
            svg += `</g></svg>`;
            const b = new Blob([svg], {type: 'image/svg+xml'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'raster.svg'; a.click();
        }

        ui.btnExport.addEventListener('click', () => { const format = ui.inputExportFormat.value; if (format === 'png') { downloadPNG(); } else { downloadSVG(); } });

        updateVisuals();
    </script>
</body>
</html>
